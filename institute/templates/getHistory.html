{% extends "base.html" %}
{% block content %}

    <div class="container" id='report'>
    <br>
        <div class="row" align="center">
            <div class="col-md-1">
            </div>
	    <div class="col-md-10">
	    	<div class="panel panel-info">
			<div class="panel-heading">
			검색 조건
			</div>
			<div class="panel-body">
        			<form action="getHistory" method="POST">
            			<div class="col-md-5">
                			<label>학원</label> 
                			<select class="form-control" id="aid" name="aid">
                        			{% for aca in academy %}
                        			<option value="{{aca.id}}" {% if aca.id == aid|add:0 %} selected {% endif %}>{{aca.name}}</option>
                        			{% endfor %}
                			</select>
            			</div>
            			<div class="col-md-5">
                    			<label>기간</label>
                    			<input class="form-control calendar" name="daterange" type="text" id="daterange">
            			</div>
            			<div class="col-md-2" align="right">
                			<br>
                			<button class="btn btn-info" onclick="submit()" type="button" value="dateAcademy">적용</button>              
            			</div>
        			</form>
			</div>
	    	</div>
	    </div>
            <div class="col-md-1">
            </div>
        </div>
	<div class="row" align="center">
		<div class="col-md-1">
		</div>
		<div class="col-md-10">
			<div class="panel panel-info">
                        	<div class="panel-heading">
				운행횟수 및 요금
				</div>
				
                        	<div class="panel-body">
					<div class="col-md-5" align="center">
				총운행횟수 : <span id="total_count"></span><br>
						<div class="etc">
				정상(<span id="normal_count"></span>) + 2배(<span id="double_count"></span>) + 동승자없음(<span id="nopassenger_count"></span>) + 동승자없음&2배(<span id="nopassenger_double_count"></span>)<br>
				예상 과금횟수 : <span id="uniq_count">{{ uniq_count }}</span><br>
						</div>
					</div>
					<div class="col-md-3" align="left">
				X 운행요금
				<select class="selectpicker price_item" id="per_amount">
					<option>11,000원</option>
					<option>12,500원</option>
				</select> 
				<br>
				X ( - 특별할인 )
				<select class="selectpicker price_item" id="discount_rate"> 
					<option>0%</option>
					<option>5%</option>
					<option>10%</option>
					<option>15%</option>
					<option>20%</option>
					<option>25%</option>
					<option>30%</option>
				</select> 
				<br>
			
					</div>
					<span id="calculate_amount" style="display: none"></span>
					<div class="col-md-2" align="right">
				= 이용요금 <br>: <span id="pay_amount"></span> 원<br>
					</div>
					<div class="col-md-2" align="right">
						<button type="button" class="btn-md btn-info" id="add-memo">Memo <span class="glyphicon glyphicon-pencil"></span></button><br><br>
						<button type="button" id='pdfdown' class="btn-md btn-info">PDF <span class="glyphicon glyphicon-download-alt"></span></button>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-1">
		</div>
	</div>

	<div class="row" align="center" id="memodiv">
	</div>

        {% for dailyhistory in history %}
        <div class="row dailyhistory">
                <div class="col-md-1"></div>
                <div class="col-md-10">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                        <button type="button" class="btn-md btn-primary dailyhistory.date"> {{ dailyhistory.date}} </button>
                        </div>
                    <div class="panel-body">
                    {% for timehistory in dailyhistory.timehistory %}
			{% if timehistory.warning == 1 %}
                        <div class="panel panel-danger timehistory">
			{% else %}
                        <div class="panel panel-default timehistory">
			{% endif %}
                            <div class="panel-heading">
				<div class="row">
					<div class="col-xs-8">
                                		<button type="button" class="btn-xs btn-warning timehistoryinfo"> {{ timehistory.carnum }}호차 </button>
                                    		{% for academy in timehistory.academies %}
                                    		<button type="button" class="btn-xs btn-warning timehistoryinfo"> {{ academy }} </button>
			            		{% endfor %}
					</div>
					<div class="col-xs-4" align="right">
						<select class="selectpicker price_item priceoption">
							<option>선택</option>
							<option>X 2 (가격 2배)</option>
							<option>동승자 없음</option>
							<option>X 2 (가격 2배) & 동승자 없음</option>
						</select>
						<button class="btn-xs btn-danger glyphicon glyphicon-remove table-remove"></button>
					</div>
				</div>
                            </div>
                            <div class="panel-body">
                                <table class="table table-bordered table-reponsive">
                                    <thead>
                                        <tr>
                                            <th>시간</th>
                                            <th>주소</th>
                                            <th class="thstyle3">이름</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for s in timehistory.scheduletable %}
                                            <tr {% if s.lflag == 1 %} class="info scheduletable" {% elif s.lflag == 0 %} class="warning scheduletable" {% else %} class="scheduletable" {% endif %}>
                                                <td class="s.time"> {{ s.time }} </td>
                                                <td class="s.addr"> 
                                                {% if s.lflag == 2 %} 출발 {% elif s.lflag == 3 %} 도착 {% else %} {{ s.addr }} {% endif %} </td>
                                                <td> 
                                                {% for student in s.members.all %}
                                                    <button type="button" class="load btn-xs btn-primary student.sname" id='student.sname'>
                                                    {{ student.sname }} </button>
                                                    <ul class="dropdown-menu pull-right">
                                                    </ul>
                                                {% endfor %}
                                                <br>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>     <!-- panel body //-->
                        </div>      <!-- panel default //-->
                    {% endfor %}
                    </div>
                    </div>
                </div>
                <div class="col-md-1"></div>
    </div>
    {% endfor %}

<script type="text/javascript">
/**
 * Module for displaying "Waiting for..." dialog using Bootstrap
 *
 * @author Eugene Maslovich <ehpc@em42.ru>
 */

var waitingDialog = waitingDialog || (function ($) {
    'use strict';

	// Creating modal dialog's DOM
	var $dialog = $(
		'<div class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:100px; overflow-y:visible;">' +
		'<div class="modal-dialog modal-m">' +
		'<div class="modal-content">' +
			'<div class="modal-header"><h3 style="margin:0;"></h3></div>' +
			'<div class="modal-body">' +
				'<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>' +
			'</div>' +
		'</div></div></div>');

	return {
		/**
		 * Opens our dialog
		 * @param message Custom message
		 * @param options Custom options:
		 * 				  options.dialogSize - bootstrap postfix for dialog size, e.g. "sm", "m";
		 * 				  options.progressType - bootstrap postfix for progress bar type, e.g. "success", "warning".
		 */
		show: function (message, options) {
			// Assigning defaults
			if (typeof options === 'undefined') {
				options = {};
			}
			if (typeof message === 'undefined') {
				message = 'Loading';
			}
			var settings = $.extend({
				dialogSize: 'm',
				progressType: '',
				onHide: null // This callback runs after the dialog was hidden
			}, options);

			// Configuring dialog
			$dialog.find('.modal-dialog').attr('class', 'modal-dialog').addClass('modal-' + settings.dialogSize);
			$dialog.find('.progress-bar').attr('class', 'progress-bar');
			if (settings.progressType) {
				$dialog.find('.progress-bar').addClass('progress-bar-' + settings.progressType);
			}
			$dialog.find('h3').text(message);
			// Adding callbacks
			if (typeof settings.onHide === 'function') {
				$dialog.off('hidden.bs.modal').on('hidden.bs.modal', function (e) {
					settings.onHide.call($dialog);
				});
			}
			// Opening dialog
			$dialog.modal();
		},
		/**
		 * Closes dialog
		 */
		hide: function () {
			$dialog.modal('hide');
		}
	};

})(jQuery);

function numberWithCommas(x) {
	x = x.toString();
	var pattern = /(-?\d+)(\d{3})/;
	while (pattern.test(x)) {
		x = x.replace(pattern, "$1,$2");
	}
	return x;
}

function numberWithoutCommas(x) {
	var ret = parseInt(x.replace(/\D+/g,''));
	return ret;
}

// 화면 로딩 이후에 바로 보여주기 위해
$( function() {
	calculate();
} );

$(".price_item").on('change', function() {
	calculate();
});

function calculate() {
	var normal_count = 0;
	var double_count = 0;
	var nopassenger_count = 0;
	var nopassenger_double_count = 0;

	var priceoptions = $('.priceoption');
	for (i=0; i<priceoptions.length; i++) {
		priceoption_value = $.trim(priceoptions[i].options[priceoptions[i].selectedIndex].value);
		if (priceoption_value === "X 2 (가격 2배)") {
			double_count++;
		}
		else if (priceoption_value === "동승자 없음") {
			nopassenger_count++;
		}
		else if (priceoption_value == "X 2 (가격 2배) & 동승자 없음") {
			nopassenger_double_count++;
		} 
		else {
			normal_count++;
		}
	}

	var per_amount = $('#per_amount')[0];
	var per_amount_value = numberWithoutCommas(per_amount.options[per_amount.selectedIndex].value);
	var discount_rate = $('#discount_rate')[0];
	var discount_rate_value = numberWithoutCommas(discount_rate.options[discount_rate.selectedIndex].value);

	$('#normal_count')[0].innerText = numberWithCommas(normal_count);
	$('#double_count')[0].innerText = numberWithCommas(double_count);
	$('#nopassenger_count')[0].innerText = numberWithCommas(nopassenger_count);
	$('#nopassenger_double_count')[0].innerText = numberWithCommas(nopassenger_double_count);
	$('#total_count')[0].innerText = numberWithCommas(normal_count + double_count + nopassenger_count + nopassenger_double_count);
	$('#calculate_amount')[0].innerText = numberWithCommas(normal_count * per_amount_value + double_count * 2 * per_amount_value + nopassenger_count * (per_amount_value - 3000) + nopassenger_double_count * (per_amount_value - 3000) * 2);
	$('#pay_amount')[0].innerText = numberWithCommas((normal_count * per_amount_value + double_count * 2 * per_amount_value + nopassenger_count * (per_amount_value - 3000) + nopassenger_double_count * (per_amount_value - 3000) * 2 )* (100 - discount_rate_value)/ 100);
	return null;
}

function todayLoad(offset,invenid, stableid){
    var btnid = invenid+''+stableid+''+offset
    console.log(btnid)
    $.ajax({
      url:"/inventory/todayLoad",
      type:"POST",
      data:{
        offset: offset,
        invenid: invenid,
        stableid: stableid,
      },
      success: function(data){
          if(data == 0){
              $("#"+btnid).attr('class','load btn-xs btn-default dropdown-toggle')
          }
          else if(data == 1){
              $("#"+btnid).attr('class','load btn-xs btn-primary dropdown-toggle')
          }
      }
    });
}


$( function() {
            $('input[name="daterange"]').daterangepicker(
            {
                locale: {
                    format: 'YYYY-MM-DD'
                },
                {% if startdate != None %}startDate: '{{startdate}}',{% endif %}
                {% if enddate != None %}endDate: '{{enddate}}'{% endif %}
            });
} );

function findUpClass(el, classname) {
	while (el.parentNode) {
		el = el.parentNode;
		if ($(el).hasClass(classname)) {
			return el;
		}
	}
	return null;
}

$(".table-remove").click(function(event) {
	var timehistory = findUpClass(event.target, "timehistory");
	timehistory.parentElement.removeChild(timehistory);
	if ($(timehistory).hasClass("panel-default")) {
		$('#uniq_count')[0].innerHTML = $.trim($('#uniq_count')[0].innerHTML) - 1;
	}
	$('#normal_count')[0].innerHTML = $.trim($('#normal_count')[0].innerHTML) - 1;
	calculate();
});

$("#add-memo").click(function(event) {
	$('#memodiv')[0].innerHTML = `
		<div class="col-md-1">
		</div>
		<div class="col-md-10">
			<div class="panel panel-info form-group">
                        	<div class="panel-heading">
				메모
				</div>
				
                        	<div class="panel-body">
				<textarea class="form-control" rows="5" id="memo"></textarea>
				</div>
			</div>
		</div>
		<div class="col-md-1">
		</div>
		`;
});


$("#pdfdown").click(function() {
	waitingDialog.show(); 
	setTimeout(function () {
		waitingDialog.hide();
	}, 4000);

	var pay_amount = $("#pay_amount")[0].innerText;
	var calculate_amount = $("#calculate_amount")[0].innerText;
	var per_amount = $('#per_amount')[0];
	var per_amount_value = per_amount.options[per_amount.selectedIndex].value;
	var discount_rate = $('#discount_rate')[0];
	var discount_rate_value = discount_rate.options[discount_rate.selectedIndex].value;
	var normal_count = $('#normal_count')[0].innerText;
	var double_count = $('#double_count')[0].innerText;
	var nopassenger_count = $('#nopassenger_count')[0].innerText;
	var nopassenger_double_count = $('#nopassenger_double_count')[0].innerText;
	var total_count = parseInt(normal_count) + parseInt(double_count) + parseInt(nopassenger_count) + parseInt(nopassenger_double_count);
	var str = "";
	var dd = {};
	dd['style'] = { header: { fontSize: 22, bold: true} };
	dd['content'] = [];

	dd['content'].push({text: "<{{aname}} {{startdate}} ~ {{enddate}} 이용내역>", fontSize: 15, bold: true, alignment: 'center'});
	dd['content'].push({text: "\n\n총 " + total_count + "회 운행", fontSize: 12, bold: true});

        if ($('#memo') && $('#memo')[0]) {
		var memo = $('#memo')[0].value;
		dd['content'].push({text: memo + '\n\n', fontSize: 11});
	}
	if (normal_count > 0) {
		dd['content'].push({text: "-- 정상: " + normal_count + "회 운행", fontSize: 11});
		if (str != "") {
			str += " + ";
		}
		str += '(' + per_amount_value + ' x ' + normal_count + ') ';
	}
	if (double_count > 0) {
		dd['content'].push({text: "-- X2: " + double_count + "회 운행", fontSize: 11});
		if (str != "") {
			str += " + ";
		}
		per_amount_value = numberWithCommas(numberWithoutCommas(per_amount_value) * 2);
		str += '(' + per_amount_value + ' x ' + double_count + ') ';
	}
	if (nopassenger_count > 0) {
		dd['content'].push({text: "-- 동승자없이: : " + nopassenger_count + "회 운행", fontSize: 11});
		if (str != "") {
			str += " + ";
		}
		per_amount_value = numberWithCommas(numberWithoutCommas(per_amount_value) - 3000);
		str += '(' + per_amount_value + ' x ' + nopassenger_count + ') ';
	}
	if (nopassenger_double_count > 0) {
		dd['content'].push({text: "-- 동승자없이 (X2): : " + nopassenger_double_count + "회 운행", fontSize: 11});
		if (str != "") {
			str += " + ";
		}
		per_amount_value = numberWithCommas(numberWithoutCommas(per_amount_value) - 3000) * 2;
		str += '(' + per_amount_value + ' x ' + nopassenger_count + ') ';
	}
	dd['content'].push({text: '\n\n이용료: ' + str + ' = ' + calculate_amount + '원\n', fontSize: 12});
	if (discount_rate_value != '0%') {
		dd['content'].push({text: '{{aname}} 특별할인 ' + discount_rate_value + '\n', fontSize: 12});
	}
	dd['content'].push({text: '\n결제금액: ' + pay_amount + '원 \n\n', fontSize: 13, bold: true});


	dd['content'].push({text: '입금계좌: 우리은행 1005-603-067444 주식회사 에티켓\n\n\n', fontSize: 13, bold: true});
	var dailyhistory = document.getElementsByClassName("dailyhistory");
	for (var i=0; i<dailyhistory.length; i++) {
		var timehistory = dailyhistory[i].getElementsByClassName("timehistory");
		var datestr = dailyhistory[i].getElementsByClassName("dailyhistory.date")[0].innerHTML;
		dd['content'].push({text: datestr, fontSize: 12, bold: true});
		
		for (var j=0; j<timehistory.length; j++) {
			var timetable = {};
			timetable['body'] = [];
			timetable['headerRows'] = 1;
			timetable['widths'] = [50, 300, 100];
			timetable['body'].push(['시간', '주소', '이름']);
			var timehistoryinfo = timehistory[j].getElementsByClassName("timehistoryinfo");
			var timehistoryinfostr = "";
			for (var k=0; k<timehistoryinfo.length; k++) {
				timehistoryinfostr += timehistoryinfo[k].innerHTML + " ";
			}
			dd['content'].push({text: timehistoryinfostr});

			var scheduletable = timehistory[j].getElementsByClassName("scheduletable");
			for (var k=0; k<scheduletable.length; k++) {
				var rows = [];
				var studentnames = "";
				var fillColor = "";
				rows[0] = {'text': $.trim(scheduletable[k].getElementsByClassName("s.time")[0].innerHTML), 'fillColor': '#eeeeee'};
				if (scheduletable[k].classList.contains("info")) {
					fillColor = '#CBDAF6';
				}
				else if (scheduletable[k].classList.contains("warning")) {
					fillColor = '#F1F6CB';
				}
				rows[1] = {'text': $.trim(scheduletable[k].getElementsByClassName("s.addr")[0].innerHTML), 'fillColor': fillColor};
				var students = scheduletable[k].getElementsByClassName("student.sname");
				for (var l=0; l<students.length; l++) {
					studentnames += $.trim(students[l].innerHTML);
					if (l < students.length -1) {
						studentnames += ", ";
					}
				}
				rows[2] = studentnames;
				timetable['body'].push(rows);
			}
			dd['content'].push({table: timetable});
			dd['content'].push({text: '   \n'});
		}
		dd['content'].push({text: '   \n'});
	}

	var filename = "{{ startdate }}_{{ enddate }}_{{ aname }}.pdf";
	pdfMake.createPdf(dd).download(filename);

});

</script>

{% endblock content %}
